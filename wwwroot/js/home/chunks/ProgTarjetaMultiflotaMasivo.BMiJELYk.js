import{r as a,j as e,u as oe}from"../index.DKk2s01l.js";import{L as re}from"./Stack.eFpAXuqd.js";import{B as le}from"./BaseTablaMatriz2.CIkwegTK.js";import{C as ne}from"./ConfirmDialog.BufNe_9b.js";import{u as ie}from"./useTablaVirtualizadaCustom.YaVcVRmy.js";import{r as ce,u as de}from"./xlsx.D6SFf1Cq.js";import{A as ue}from"./AlertDialog.CDEXBAMG.js";const fe=({onFileSelected:S,disabled:l=!1})=>{const[A,c]=a.useState(""),s=a.useRef(null),C=v=>{const n=v.target.files?.[0];if(!n)return;c(n.name);const T=new FileReader;T.onload=d=>{const y=d.target.result;S&&S({file:n,arrayBuffer:y})},T.readAsArrayBuffer(n)},j=()=>{l||s.current.click()};return e.jsxs("div",{className:"flex flex-col gap-3 w-full max-w-md",children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700",children:"Seleccionar archivo Excel"}),e.jsxs("div",{onClick:j,className:`w-full p-5 border-2 border-dashed rounded-xl flex flex-col items-center justify-center gap-2 transition-all duration-200
                  ${l?"bg-gray-100 border-gray-200 opacity-60 cursor-not-allowed select-none":"cursor-pointer border-gray-300 hover:border-blue-500 hover:bg-blue-50"}`,children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`w-10 h-10 ${l?"text-gray-300":"text-gray-500"}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 4v16m8-8H4"})}),e.jsx("p",{className:`text-sm ${l?"text-gray-400":"text-gray-600"}`,children:l?"deshabilitado para subir archivos":"Haz clic para seleccionar un archivo Excel"}),A&&e.jsxs("p",{className:"text-sm font-medium text-green-700 mt-1",children:["Archivo seleccionado: ",e.jsx("span",{className:"underline",children:A})]})]}),e.jsx("input",{ref:s,type:"file",accept:".xls, .xlsx",disabled:l,onChange:C,className:"hidden"})]})},Ae=()=>{oe().state?.value;const[l,A]=a.useState(Date.now()),[c,s]=a.useState([]),[C,j]=a.useState({}),[v,n]=a.useState(!1),[T,d]=a.useState(!1),[y,w]=a.useState(!1),[K,D]=a.useState(!1),[J,E]=a.useState(""),[V,I]=a.useState("success"),[W,L]=a.useState(!1),[Y,z]=a.useState(!1),[H,X]=a.useState({visible:!1,message:""});a.useEffect(()=>{s([])},[]);const{runFetch:q}=ie(),Q=({file:u,arrayBuffer:f})=>{const m=ce(f,{type:"array"}),R=m.Sheets[m.SheetNames[0]],t=de.sheet_to_json(R,{default:""}),P=Object.keys(t[0]||{}),h=[],p=[],x={},i={},g={};t.forEach((r,_)=>{const te=_+2,b=P.map(se=>(r[se]??"").toString().trim()),N=`${te}|${b.join("|")}`;if(!b[0]||!b[2]){p.push(`${N}|datos incompletos`);return}const G=b[2];x[G]||(x[G]=[]),x[G].push(`${N}|Nro tarjeta duplicado`);const U=b[0];i[U]||(i[U]=[]),i[U].push(`${N}|Placa Interna duplicado`);const B=b[1];g[B]||(g[B]=[]),g[B].push(`${N}|Placa Rodaje duplicado`),h.push(N)});const O=Object.values(x).filter(r=>r.length>1).flat(),$=Object.values(i).filter(r=>r.length>1).flat(),F=Object.values(g).filter(r=>r.length>1).flat().filter(r=>r.split("|")[2].trim()!=="");let o;p.length>0?(o=["Nro|Placa Interna|Placa Rodaje|Nro Tarjeta Multiflota|DATOS INVALIDOS","50|200|200|400|600"],p.unshift(o),s(p.flat())):O.length>0?(o=["Nro|Placa Interna|Placa Rodaje|Nro Tarjeta Multiflota|Nro Tarjetas Multiflota Duplicados","50|200|200|400|800"],O.unshift(o),s(O.flat())):$.length>0?(o=["Nro|Placa Interna|Placa Rodaje|Nro Tarjeta Multiflota|Nro Placa Interna Duplicados","50|200|200|400|800"],$.unshift(o),s($.flat())):F.length>0?(o=["Nro|Placa Interna|Placa Rodaje|Nro Tarjeta Multiflota|Nro Placa Rodaje Duplicados","50|200|200|400|800"],F.unshift(o),s(F.flat())):(o=["Nro|Placa Interna|Placa Rodaje|Nro Tarjeta Multiflota","50|200|200|400"],h.unshift(o),s(h.flat())),z(!0)},Z=()=>{if(c.length>0){const u=c[0].split("|").length;d(u===5);const f="RESULTADO DE CARGA MASIVA DE TARJETAS MULTIFLOTA:";j(m=>({...m,title:f,isPaginar:!0,listaDatos:c,offsetColumnas:0})),n(!0),w(!0)}else X({visible:!0,message:"Debe cargar un archivo para procesar..."})},M=()=>{s([]),j(u=>({...u,listaDatos:c})),n(!1),d(!1),w(!1),A(Date.now()),z(!1)},ee=()=>{D(!0)},ae=async()=>{L(!0);const u=c.slice(2).map(t=>{const[P,...h]=t.split("|");return h.join("|")});let f=2e3;const m=u.join("~"),R=new FormData;R.append("data",m);try{const t=await q("/Page/GrabarTarjetaMultiflotaMasivo",{method:"POST",body:R});if(t)if(L(!1),E("Proceso Terminado satisfactoriamente..."),I("success"),n(!0),w(!1),d(!0),t.trim()!=="ok")if(t.trim().startsWith("error"))E("El archivo excel tiene DUPLICADO DE Nro PLACA INTERNA. Corrija los datos...!!!"),I("warning"),M(),f=3e3;else{const P=["Nro|Placa Interna|Placa Rodaje|Nro Tarjeta Multiflota|OBSERVACION","50|200|200|400|500"],p=t.trim().split("~").map((i,g)=>`${g+1}|${i}`),x=[...P,...p];j(i=>({...i,listaDatos:x}))}else M()}catch(t){L(!1),console.error(t),E("Error al guardar la informacion ..."),I("error")}finally{setTimeout(()=>{E("")},f)}},k=a.useCallback(()=>{},[]);return e.jsxs(e.Fragment,{children:[W&&e.jsx(re,{}),e.jsxs("div",{className:"text-xl font-bold mb-4 text-green-800 flex items-center justify-between gap-2",children:[e.jsx("h2",{className:"mt-4 text-lg font-semibold text-green-700 mb-4 border-b border-green-300 pb-1",children:"CARGA MASIVA DE LAS TARJETAS MULTIFLOTA :"}),e.jsx("a",{href:"/Page/DescargarPlantillaMultiflota",className:"mt-4 text-sm font-medium text-blue-600 underline hover:text-blue-800 transition",children:"DESCARGAR PLANTILLA EXCEL"})]}),e.jsx("div",{className:"p-4",children:e.jsx(fe,{onFileSelected:Q,disabled:Y},l)}),J&&e.jsx("div",{className:`mt-3 p-3 text-sm rounded-md shadow-md ${V==="success"?"bg-green-700 text-white animate-bounce":V==="warning"?"bg-yellow-400 text-black animate-bounce":"bg-red-400 text-white animate-bounce"}`,children:J}),e.jsxs("div",{className:"flex justify-end items-center w-full gap-4 mt-8 mb-2",children:[e.jsx("button",{type:"button",disabled:!!T,onClick:y?ee:Z,className:`
              px-4 py-2 rounded-md text-white transition
              bg-green-700 hover:bg-green-900
              disabled:bg-gray-400 disabled:text-gray-200 disabled:cursor-not-allowed
            `,children:y?"PROCESAR":"MOSTRAR CARGA"}),e.jsx("button",{type:"button",onClick:M,className:"px-4 py-2 rounded-md shadow-sm bg-gray-300 text-black cursor-pointer opacity-50",children:"LIMPIAR"})]}),K&&e.jsx(ne,{message:"Â¿Deseas guardar los cambios?",onConfirm:()=>{D(!1),ae()},onCancel:()=>D(!1)}),!v&&e.jsx("h2",{className:"mt-4 text-lg font-semibold text-green-700 mb-4 border-b border-green-300 pb-1",children:"Listado con formato XLXS : ( PLACA INTERNA - - PLACA RODAJE - - Nro TARJETA )"}),e.jsx("div",{className:"mb-4 flex-1 min-h-0 overflow-y-auto pr-2",children:v&&e.jsx("div",{style:{maxHeight:"80vh",overflowY:"auto",border:"1px solid #e5e7eb",borderRadius:"0.5rem"},children:e.jsx(le,{configTable:C,handleRadioClick:k,handleCheckDelete:k,isEditing:!1,onSelect:k})})}),H.visible&&e.jsx(ue,{message:H.message,onClose:()=>X({visible:!1,message:""})})]})};export{Ae as default};
