import{u as we,r as p,f as Ce,j as m}from"../index.DKk2s01l.js";import{a as Ae,C as V,u as z}from"./CustomElement.A4zDmkLk.js";import{B as ye}from"./BaseTablaMatriz2.CIkwegTK.js";import{C as Ne}from"./ConfirmDialog.BufNe_9b.js";import{A as De}from"./AlertDialog.CDEXBAMG.js";import{u as ke}from"./useFetch.D2-L_2OD.js";import{u as Ie}from"./useTablaVirtualizadaCustom.YaVcVRmy.js";import"./Stack.eFpAXuqd.js";const _e=()=>{const q=we().state?.value,[w,R]=p.useState({}),[te,C]=p.useState({}),[ae,j]=p.useState({}),[M,A]=p.useState(!1),[O,B]=p.useState({}),[H,U]=p.useState(""),[se,y]=p.useState(!1),[_,E]=p.useState(""),[$,N]=p.useState("success"),[oe,S]=p.useState(!1),[ne,re]=p.useState(0),[G,x]=p.useState({visible:!1,message:""}),d=p.useRef([]),J="/Home/TraerTarjetaMultiflota",{data:D,loading:ie,error:K}=ke(J),{runFetch:L}=Ie(),le=Ae(d),{handleClick:ce,mensajeError:W,esValido:Z,valoresCambiados:k}=le,{menuTrigger:de}=Ce(),ue=()=>{R({}),C({}),j({}),A(!1),B({}),U(""),y(!1),E(""),N("success"),S(!1),d.current.forEach(e=>{e&&(e.value="",e.dataset.value="",e.dataset.valor="",e.type==="checkbox"&&(e.checked=!1))}),["990","991"].forEach(e=>{re(o=>o+1);const n=d.current.filter(Boolean).find(o=>o.dataset.item===e);n&&n.tagName==="SELECT"&&(C(o=>({...o,[e]:{value:"",label:""}})),j(o=>({...o,[e]:0})))}),d.current=[],z.setState({selectedItems:[]})};p.useEffect(()=>{ue()},[de]);const me=async a=>{const e=`zz|${a}`,n=await L(`${J}Param?dato=${encodeURIComponent(e)}`,{method:"GET",headers:{Accept:"text/plain","Content-Type":"text/plain"}});if(n.startsWith("error")){console.warn("error");return}const o=typeof n=="string"?n.split("~"):[],t=o?.[0]?.split("|")??[],v=o?.[1]?.split("|")??[],u=o?.slice(3)?.join("~");t.length===1&&(setTimeout(()=>{d.current.forEach(i=>{i&&i.dataset&&(i.dataset.valor="")})},100),A(!1));const c=v.map((i,r)=>({data:t[r]??"",metadata:(i??"").split("*")}));if([{item:"2",index:4},{item:"3",index:5},{item:"4",index:6}].forEach(({item:i,index:r})=>{const l=d.current.filter(Boolean).find(g=>g?.dataset.item===i),s=c[r]?.data,h=String(s??"").trim();l&&(l.dataset.value=h,l.value=h)}),setTimeout(()=>{const i=c[7]?.data,r=String(i??"").trim(),l=d.current.filter(Boolean).find(s=>s?.dataset.item==="5");if(l.tagName==="INPUT"&&l.type==="checkbox"){const s=r==="1";l.dataset.value=s?"1":"0",l.checked=s}},100),c.filter(i=>i.metadata?.[5]==="100").forEach(i=>{const r=i.metadata[0],l=i.data;l&&l.trim()!==""&&(d.current.forEach(s=>{s?.type==="hidden"&&s.dataset.campo===r&&(s.value=l,s.dataset.value=l)}),A(!0))}),u){const i=u.split("~");if(i.length===2)return;B(r=>({...r,title:"HISTORIAL DE CAMBIOS DE TARJETAS MULTIFLOTA:",isPaginar:!1,listaDatos:i,offsetColumnas:0}))}setTimeout(()=>{d.current.forEach(i=>{i&&i.dataset&&(i.dataset.valor=i.dataset.value)})},100)};p.useEffect(()=>{me(H)},[H]);const Y=p.useCallback(async()=>{const a=[...k.data],e=[...k.campos],n=[...k.items],o=new Set;let t="";if(!a.length&&!e.length){E("NO existen datos que enviar"),N("error"),setTimeout(()=>E(""),2e3);return}d.current.filter(Boolean).filter(s=>s?.type==="hidden").forEach(s=>{const h=s.dataset.campo??"",g=s.dataset.value??"",b=s.dataset.item??"";o.add(JSON.stringify({campo:h,value:g,item:b}))}),o.forEach(s=>{const{campo:h,value:g,item:b}=JSON.parse(s);e.unshift(h),a.unshift(g),n.unshift(b)});const u=a?.[2]??"";if((O?.listaDatos??[]).length>0){const s=O.listaDatos.slice(2).filter(h=>{const g=h.split("|");return String(g[0]??"").trim()===u});if(s&&s.length>0){x({visible:!0,message:"No se permite Nro Tarjeta Duplicado, por favor verifique ..."});return}}const c=(n??[]).reduce((s,h,g)=>(s[h]=a[g],s),{}),f=String(c[2]??"");if(f!==""&&!/^[A-Za-z0-9]+$/.test(f)){x({visible:!0,message:"Sólo se permiten letras (A-Z, a-z) y números (0-9). Por favor corrija."});return}const r=d.current.filter(Boolean).find(s=>s.dataset.item==="5");if(r){const s=r.dataset.value,h=r.dataset.valor;if(s===h&&s==="1"&&!r.checked){x({visible:!0,message:"Debe Activar la Tarjeta"});return}}if(c[3]!==void 0&&c[4]===void 0&&(c[5]===void 0||c[5]==="0")){x({visible:!0,message:"Debe Activar la Tarjeta"});return}t=q.trim()+"~"+a.join("|")+"|"+e.join("|");const l=new FormData;l.append("data",t);try{const s=await L("/Home/GrabarTarjetaMultiflota",{method:"POST",body:l});if(s)if(s.trim().startsWith("duplicado"))x({visible:!0,message:"El nro de Tarjeta ya existe, por favor verifique ..."});else if(s.trim().startsWith("existe"))x({visible:!0,message:"Existe una tarjeta activa para ese vehiculo, por favor verifique ..."});else{if(s.trim()!==""){E("Datos Guardados Correctamente ..."),N("success"),A(!0);const h=s.trim().split("^"),g=d.current.filter(Boolean).find(b=>b?.dataset?.item==="10");if(g.dataset.value=h?.[0],h.length>1){const b=h.slice(1).flatMap(P=>P.split("~"));b[2].split("|")[2].trim()!==""?S(!0):S(!1),B(P=>({...P,listaDatos:b}))}}d.current.forEach(h=>{h&&(h.dataset.valor=h.dataset.value??"")})}}catch(s){console.error(s),E("Error al guardar la informacion ..."),N("error")}finally{setTimeout(()=>{E("")},2e3)}},[k,q,L]);p.useEffect(()=>{Z&&Y()},[Z,Y]);const F=typeof D?.[0]=="string"?D?.[0]?.split("~"):[],fe=F?.[0]?.split("|")??[],he=F?.[1]?.split("|")??[],pe=F?.[2]?.split("|")??[],Q=(he??[]).map((a,e)=>({data:(fe??[])[e]??"",metadata:(a??"").split("*")})).map(a=>{const e=[...a.metadata??[]],n=e[9];if(n&&n.includes("+")){const[o,t]=n.split("+");return e[9]=o,{...a,metadata:e,_orden:Number(t)||0}}return{...a,metadata:e,_orden:0}}).sort((a,e)=>a._orden-e._orden).map(({_orden:a,...e})=>e),X=(D??[]).slice(1),I=p.useMemo(()=>(X??[]).reduce((a,e)=>{const[n,...o]=e.split("~");return a[n]=o,a},{}),[X]),ee=pe.map(a=>{const[e,n]=a.split("*");return{id:e,nombre:n}}).filter(a=>a.id!==void 0).map(a=>({...a,items:Q.filter(e=>e.metadata[9]===a.id)})),ve=()=>{console.log("handlePopup")},ge=()=>new Promise(a=>{const e=()=>{d.current.length>0?a():requestAnimationFrame(e)};e()}),T=a=>d.current?.find?.(e=>e?.dataset?.item===a)??null,be=async a=>{await ge();const{selectedItems:e}=z.getState();if(!e||e.length===0)return;const n=e[0],t=(I[a]?.slice(1)?.[0]?.split("*")??[]).map(u=>{const[c,f]=u.split("|");return{item:c,indice:Number(f)}});R(u=>{const c={...u};return t.forEach(({item:f,indice:i})=>{const r=T(f);if(!r)return;const l=n[i]??"";r.value=l,r.dataset.value=l;const s=u[f]??{};c[f]={...s,value:l,item:r.dataset.item??""},r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0}))}),c}),setTimeout(()=>{const u=T("11");u&&(u.dataset.value=n[0],u.value=n[0])},500),setTimeout(()=>{const c=T("990");c&&c.tagName==="SELECT"&&(c.dataset.value=n[1],C(r=>({...r,990:{value:n[1],label:n[1]}})),j(r=>({...r,990:1})));const f="991",i=T(f);i&&i.tagName==="SELECT"&&(i.dataset.value=n[2],C(r=>({...r,[f]:{value:n[2],label:n[2]}})),j(r=>({...r,[f]:1}))),setTimeout(()=>{U(n[0])},500)},1e3),setTimeout(()=>{const u=new Date,c=new Date(u.getTime()-u.getTimezoneOffset()*6e4).toISOString().split("T")[0],f=T("3"),i=T("4"),r=T("5");r&&(r.checked=!0,r.dispatchEvent(new Event("change",{bubbles:!0}))),f&&f.dataset.valor===""&&(f.dataset.value=c,f.value=c),i&&i.dataset.valor===""?S(!1):S(!0)},2e3);const{setSelectedItems:v}=z.getState();v([])},xe=a=>{const{value:e,valor:n,item:o}=a.target.dataset;let t=n;const v=d.current.filter(Boolean).find(c=>c.dataset.item==="3"),u=d.current.filter(Boolean).find(c=>c.dataset.item==="4");if(o==="5"){t=a.target.type==="checkbox"?a.target.checked?"1":"0":a.target.dataset.valor;const f=d.current.filter(Boolean).find(l=>l.dataset.item===o).checked,i=new Date,r=new Date(i.getTime()-i.getTimezoneOffset()*6e4).toISOString().split("T")[0];v.dataset.valor===""?f?(v.value=r,v.dataset.value=r):(v.value="",v.dataset.value=""):f?(u.value="",u.dataset.value=""):(u.value=r,u.dataset.value=r)}R(c=>({...c,[o]:{value:e,valor:t,item:o}}))},Te=()=>{const a=d.current.filter(Boolean).find(e=>e?.dataset?.item==="4");if(a&&a.dataset.valor!==""){let e=["10","2","3","4","5"];e.forEach(n=>{const o=d.current.filter(Boolean).find(t=>t?.dataset?.item===n);o&&(o.value="",o.dataset.value="",o.dataset.valor="",o.type==="checkbox"&&(o.checked=!1),o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})))}),e=["990","991"],e.forEach(n=>{const o=d.current.filter(Boolean).find(t=>t?.dataset?.item===n);o&&(o.dataset.valor="")})}else{const e=d.current.filter(Boolean).find(t=>t?.dataset?.item==="2");e&&(e.dataset.valor="",e.dataset.value="",e.value="");const n=d.current.filter(Boolean).find(t=>t?.dataset?.item==="3");n&&(n.dataset.valor="",n.dataset.value="",n.value="");const o=d.current.filter(Boolean).find(t=>t?.dataset?.item==="5");o&&(o.checked=!1)}},Ee=a=>I?.[a]??[],je=()=>{y(!0)};if(p.useEffect(()=>{d.current=d.current.filter(a=>a!==null)},[ee]),ie)return m.jsx("div",{children:"Cargando datos..."});if(K)return m.jsxs("div",{children:["Error: id_vehiculo",K.message]});if(!D)return m.jsx("div",{children:"No hay datos disponibles"});const Se={990:"/Home/TraerTarjetaMultiflotaPlacaInterna",991:"/Home/TraerTarjetaMultiflotaPlacaRodaje"};return m.jsxs(m.Fragment,{children:[m.jsxs("div",{className:"text-xl font-bold mb-4 text-green-800 flex items-center justify-between gap-2",children:[m.jsx("h2",{className:"mt-4 text-lg font-semibold text-green-700 mb-4 border-b border-green-300 pb-1",children:"MANTENIMIENTO DE TARJETAS MULTIFLOTA :"}),m.jsx("span",{className:"text-green-800",children:M?"EDITAR":"NUEVO"})]}),ee.map(a=>a.items.length>0&&m.jsxs("div",{className:"mb-8",children:[m.jsx("h2",{className:"text-lg font-semibold text-green-700 mb-4 border-b border-green-300 pb-1",children:a.nombre}),m.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:a.items.map(e=>{const n=Q.findIndex(l=>l.metadata[0]===e.metadata[0]),{data:o,metadata:t}=e,v=Number(t?.[5]??0);let u=t?.[3]?Number(t[3]):0;const c=t?.[1]==="0",f=t?.[8]==="1",i=t?.[14]==="1";u=t?.[4]===""?u:Number(t[4]);const r={"-1":"w-1/2",1:"col-span-1",2:"col-span-2",3:"col-span-3",4:"col-span-4"};return m.jsx("div",{className:`${r[t?.[10]]??"col-span-1"} min-w-0`,children:m.jsx(V,{ref:l=>{l&&(d.current[t[6]]=l)},typeCode:v,etiqueta:t[7]??"",placeholder:t[7]??"",popupTipo:t[6]??"",url:Se[t[6]]??"",onPopupClick:()=>ve(t[6]),onPopupClose:()=>be(t[6]),style:i?{visibility:"hidden",position:"absolute",width:0,height:0,overflow:"hidden"}:{},...u>0?{maxLength:u}:{},...f?{disabled:!0}:{},...c?{required:!0}:{},...v===103?{checked:(w[t[6]]?.value??o)==="1"}:{},...t?.[2]==="1"&&v===101?{tipoDato:"entero"}:{},...t?.[2]==="2"&&v===101?{tipoDato:"decimal"}:{},...v===111?{defaultValue:I[t[6]]?.length>0?e.metadata[0]:"",...t?.[11]==="1"?{isDefault:1}:{}}:v===151?{defaultValue:e.data,unaLinea:t?.[11],offsetColumnas:t?.[12],ancho:t?.[13],isFilter:(t[0]==="1.11",""),forcedOption:te?.[t[6]]??null,optionFlag:ae?.[t[6]]??null,setOptionFlag:l=>{j(s=>({...s,[t[6]]:l}))}}:{defaultValue:e.data},dataAttrs:{value:w[t[6]]?.value??o,valor:o,campo:t[0],item:t[6]},onChange:xe,...I[t[6]]||w[t[0]]?.listaAux?{options:(()=>{const l=Ee(t[6])||[],s=w[t[0]]?.listaAux,h=Array.isArray(s)?s.filter(g=>g&&g.trim()!==""):[];return l.concat(h)})()}:{}})},`${n}-${ne}`)})})]},a.id)),oe&&m.jsx("div",{className:"flex justify-between items-center w-full gap-4 mt-8 mb-2",children:m.jsx(V,{typeCode:120,onClick:Te,className:"!w-auto",children:"NUEVA TARJETA MULTIFLOTA"})}),!M&&m.jsx("h2",{className:"mt-4 text-lg font-semibold text-green-700 mb-4 border-b border-green-300 pb-1",children:"HISTORIAL DE CAMBIOS DE TARJETAS MULTIFLOTA :"}),m.jsx("div",{className:"mb-4 flex-1 min-h-0 overflow-y-auto pr-2",children:M&&m.jsx("div",{style:{maxHeight:"50vh",overflowY:"auto",border:"1px solid #e5e7eb",borderRadius:"0.5rem"},children:m.jsx(ye,{configTable:O,handleRadioClick:()=>{},handleCheckDelete:()=>{},isEditing:!1,onSelect:()=>{}})})}),m.jsxs("div",{className:"mt-8 mb-2",children:[W&&m.jsx("div",{className:"mt-3 p-3 text-sm text-white bg-red-400 rounded-md shadow-md animate-bounce",children:W}),_&&m.jsx("div",{className:`mt-3 p-3 text-sm rounded-md shadow-md ${$==="success"?"bg-green-700 text-white animate-bounce":$==="warning"?"bg-yellow-400 text-black animate-bounce":"bg-red-400 text-white animate-bounce"}`,children:_}),m.jsx("div",{className:"flex justify-between items-center w-full gap-4 mt-8 mb-2",children:m.jsx(V,{typeCode:120,onClick:je,className:"!w-auto",children:"GRABAR"})}),se&&m.jsx(Ne,{message:"¿Deseas guardar los cambios?",onConfirm:()=>{y(!1),ce()},onCancel:()=>y(!1)})]}),G.visible&&m.jsx(De,{message:G.message,onClose:()=>x({visible:!1,message:""})})]})};export{_e as default};
