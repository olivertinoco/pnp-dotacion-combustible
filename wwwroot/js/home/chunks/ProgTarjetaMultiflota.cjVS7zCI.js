import{u as Se,r as p,f as we,j as u}from"../index.BrPz-MZr.js";import{a as Ce,C as P,u as V}from"./CustomElement.C6AuAZ9V.js";import{B as Ae}from"./BaseTablaMatriz2.CFIIuuYC.js";import{C as ye}from"./ConfirmDialog.YkHAmLtH.js";import{A as Ne}from"./AlertDialog.CMLhEkp2.js";import{u as De}from"./useFetch.ClVmkW40.js";import{u as Ie}from"./useTablaVirtualizadaCustom.y-cIBxX4.js";import"./Stack.DPLBjCES.js";const Ue=()=>{const z=Se().state?.value,[S,k]=p.useState({}),[ee,w]=p.useState({}),[te,E]=p.useState({}),[R,C]=p.useState(!1),[L,M]=p.useState({}),[q,H]=p.useState(""),[ae,A]=p.useState(!1),[U,T]=p.useState(""),[_,y]=p.useState("success"),[se,j]=p.useState(!1),[oe,ne]=p.useState(0),[$,b]=p.useState({visible:!1,message:""}),m=p.useRef([]),G="/Home/TraerTarjetaMultiflota",{data:N,loading:re,error:J}=De(G),{runFetch:O}=Ie(),ie=Ce(m),{handleClick:le,mensajeError:K,esValido:W,valoresCambiados:D}=ie,{menuTrigger:ce}=we(),de=()=>{k({}),w({}),E({}),C(!1),M({}),H(""),A(!1),T(""),y("success"),j(!1),m.current.forEach(e=>{e&&(e.value="",e.dataset.value="",e.dataset.valor="",e.type==="checkbox"&&(e.checked=!1))}),["990","991"].forEach(e=>{ne(o=>o+1);const i=m.current.filter(Boolean).find(o=>o.dataset.item===e);i&&i.tagName==="SELECT"&&(w(o=>({...o,[e]:{value:"",label:""}})),E(o=>({...o,[e]:0})))}),m.current=[],V.setState({selectedItems:[]})};p.useEffect(()=>{de()},[ce]);const ue=async a=>{const e=`zz|${a}`,i=await O(`${G}Param?dato=${encodeURIComponent(e)}`,{method:"GET",headers:{Accept:"text/plain","Content-Type":"text/plain"}});if(i.startsWith("error")){console.warn("error");return}const o=typeof i=="string"?i.split("~"):[],t=o?.[0]?.split("|")??[],h=o?.[1]?.split("|")??[],d=o?.slice(3)?.join("~");t.length===1&&(setTimeout(()=>{m.current.forEach(r=>{r&&r.dataset&&(r.dataset.valor="")})},100),C(!1));const c=h.map((r,n)=>({data:t[n]??"",metadata:(r??"").split("*")}));if([{item:"2",index:4},{item:"3",index:5},{item:"4",index:6}].forEach(({item:r,index:n})=>{const s=m.current.filter(Boolean).find(g=>g?.dataset.item===r),l=c[n]?.data,v=String(l??"").trim();s&&(s.dataset.value=v,s.value=v)}),setTimeout(()=>{const r=c[7]?.data,n=String(r??"").trim(),s=m.current.filter(Boolean).find(l=>l?.dataset.item==="5");if(s.tagName==="INPUT"&&s.type==="checkbox"){const l=n==="1";s.dataset.value=l?"1":"0",s.checked=l}},100),c.filter(r=>r.metadata?.[5]==="100").forEach(r=>{const n=r.metadata[0],s=r.data;s&&s.trim()!==""&&(m.current.forEach(l=>{l?.type==="hidden"&&l.dataset.campo===n&&(l.value=s,l.dataset.value=s)}),C(!0))}),d){const r=d.split("~");if(r.length===2)return;M(n=>({...n,title:"HISTORIAL DE CAMBIOS DE TARJETAS MULTIFLOTA:",isPaginar:!1,listaDatos:r,offsetColumnas:0}))}setTimeout(()=>{m.current.forEach(r=>{r&&r.dataset&&(r.dataset.valor=r.dataset.value)})},100)};p.useEffect(()=>{ue(q)},[q]);const Z=p.useCallback(async()=>{const a=[...D.data],e=[...D.campos],i=[...D.items],o=new Set;let t="";if(!a.length&&!e.length){T("NO existen datos que enviar"),y("error"),setTimeout(()=>T(""),2e3);return}m.current.filter(Boolean).filter(s=>s?.type==="hidden").forEach(s=>{const l=s.dataset.campo??"",v=s.dataset.value??"",g=s.dataset.item??"";o.add(JSON.stringify({campo:l,value:v,item:g}))}),o.forEach(s=>{const{campo:l,value:v,item:g}=JSON.parse(s);e.unshift(l),a.unshift(v),i.unshift(g)});const d=a?.[2]??"";if((L?.listaDatos??[]).length>0){const s=L.listaDatos.slice(2).filter(l=>{const v=l.split("|");return String(v[0]??"").trim()===d});if(s&&s.length>0){b({visible:!0,message:"No se permite Nro Tarjeta Duplicado, por favor verifique ..."});return}}const c=(i??[]).reduce((s,l,v)=>(s[l]=a[v],s),{}),f=String(c[2]??"");if(f!==""&&!/^[A-Za-z0-9]+$/.test(f)){b({visible:!0,message:"Sólo se permiten letras (A-Z, a-z) y números (0-9). Por favor corrija."});return}if(c[3]!==void 0&&c[4]===void 0&&(c[5]===void 0||c[5]==="0")){b({visible:!0,message:"Debe Activar la Tarjeta"});return}t=z.trim()+"~"+a.join("|")+"|"+e.join("|");const n=new FormData;n.append("data",t);try{const s=await O("/Home/GrabarTarjetaMultiflota",{method:"POST",body:n});if(s)if(s.trim().startsWith("duplicado"))b({visible:!0,message:"El nro de Tarjeta ya existe, por favor verifique ..."});else if(s.trim().startsWith("existe"))b({visible:!0,message:"Existe una tarjeta activa para ese vehiculo, por favor verifique ..."});else{if(s.trim()!==""){T("Datos Guardados Correctamente ..."),y("success"),C(!0);const l=s.trim().split("^"),v=m.current.filter(Boolean).find(g=>g?.dataset?.item==="10");if(v.dataset.value=l?.[0],l.length>1){const g=l.slice(1).flatMap(B=>B.split("~"));g[2].split("|")[2].trim()!==""?j(!0):j(!1),M(B=>({...B,listaDatos:g}))}}m.current.forEach(l=>{l&&(l.dataset.valor=l.dataset.value??"")})}}catch(s){console.error(s),T("Error al guardar la informacion ..."),y("error")}finally{setTimeout(()=>{T("")},2e3)}},[D,z,O]);p.useEffect(()=>{W&&Z()},[W,Z]);const F=typeof N?.[0]=="string"?N?.[0]?.split("~"):[],me=F?.[0]?.split("|")??[],fe=F?.[1]?.split("|")??[],pe=F?.[2]?.split("|")??[],Y=(fe??[]).map((a,e)=>({data:(me??[])[e]??"",metadata:(a??"").split("*")})).map(a=>{const e=[...a.metadata??[]],i=e[9];if(i&&i.includes("+")){const[o,t]=i.split("+");return e[9]=o,{...a,metadata:e,_orden:Number(t)||0}}return{...a,metadata:e,_orden:0}}).sort((a,e)=>a._orden-e._orden).map(({_orden:a,...e})=>e),Q=(N??[]).slice(1),I=p.useMemo(()=>(Q??[]).reduce((a,e)=>{const[i,...o]=e.split("~");return a[i]=o,a},{}),[Q]),X=pe.map(a=>{const[e,i]=a.split("*");return{id:e,nombre:i}}).filter(a=>a.id!==void 0).map(a=>({...a,items:Y.filter(e=>e.metadata[9]===a.id)})),he=()=>{console.log("handlePopup")},ve=()=>new Promise(a=>{const e=()=>{m.current.length>0?a():requestAnimationFrame(e)};e()}),x=a=>m.current?.find?.(e=>e?.dataset?.item===a)??null,ge=async a=>{await ve();const{selectedItems:e}=V.getState();if(!e||e.length===0)return;const i=e[0],t=(I[a]?.slice(1)?.[0]?.split("*")??[]).map(d=>{const[c,f]=d.split("|");return{item:c,indice:Number(f)}});k(d=>{const c={...d};return t.forEach(({item:f,indice:r})=>{const n=x(f);if(!n)return;const s=i[r]??"";n.value=s,n.dataset.value=s;const l=d[f]??{};c[f]={...l,value:s,item:n.dataset.item??""},n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0}))}),c}),setTimeout(()=>{const d=x("11");d&&(d.dataset.value=i[0],d.value=i[0])},500),setTimeout(()=>{const c=x("990");c&&c.tagName==="SELECT"&&(c.dataset.value=i[1],w(n=>({...n,990:{value:i[1],label:i[1]}})),E(n=>({...n,990:1})));const f="991",r=x(f);r&&r.tagName==="SELECT"&&(r.dataset.value=i[2],w(n=>({...n,[f]:{value:i[2],label:i[2]}})),E(n=>({...n,[f]:1}))),setTimeout(()=>{H(i[0])},500)},1e3),setTimeout(()=>{const d=new Date,c=new Date(d.getTime()-d.getTimezoneOffset()*6e4).toISOString().split("T")[0],f=x("3"),r=x("4"),n=x("5");n&&(n.checked=!0,n.dispatchEvent(new Event("change",{bubbles:!0}))),f&&f.dataset.valor===""&&(f.dataset.value=c,f.value=c),r&&r.dataset.valor===""?j(!1):j(!0)},2e3);const{setSelectedItems:h}=V.getState();h([])},be=a=>{const{value:e,valor:i,item:o}=a.target.dataset;let t=i;const h=m.current.filter(Boolean).find(c=>c.dataset.item==="3"),d=m.current.filter(Boolean).find(c=>c.dataset.item==="4");if(o==="5"){t=a.target.type==="checkbox"?a.target.checked?"1":"0":a.target.dataset.valor;const f=m.current.filter(Boolean).find(s=>s.dataset.item===o).checked,r=new Date,n=new Date(r.getTime()-r.getTimezoneOffset()*6e4).toISOString().split("T")[0];h.dataset.valor===""?f?(h.value=n,h.dataset.value=n):(h.value="",h.dataset.value=""):f?(d.value="",d.dataset.value=""):(d.value=n,d.dataset.value=n)}k(c=>({...c,[o]:{value:e,valor:t,item:o}}))},xe=()=>{const a=m.current.filter(Boolean).find(e=>e?.dataset?.item==="4");if(a&&a.dataset.valor!==""){let e=["10","2","3","4","5"];e.forEach(i=>{const o=m.current.filter(Boolean).find(t=>t?.dataset?.item===i);o&&(o.value="",o.dataset.value="",o.dataset.valor="",o.type==="checkbox"&&(o.checked=!1),o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})))}),e=["990","991"],e.forEach(i=>{const o=m.current.filter(Boolean).find(t=>t?.dataset?.item===i);o&&(o.dataset.valor="")})}else b({visible:!0,message:"La tarjeta debe estar cancelada para poder crear una nueva"})},Te=a=>I?.[a]??[],Ee=()=>{A(!0)};if(p.useEffect(()=>{m.current=m.current.filter(a=>a!==null)},[X]),re)return u.jsx("div",{children:"Cargando datos..."});if(J)return u.jsxs("div",{children:["Error: id_vehiculo",J.message]});if(!N)return u.jsx("div",{children:"No hay datos disponibles"});const je={990:"/Home/TraerTarjetaMultiflotaPlacaInterna",991:"/Home/TraerTarjetaMultiflotaPlacaRodaje"};return u.jsxs(u.Fragment,{children:[u.jsxs("div",{className:"text-xl font-bold mb-4 text-green-800 flex items-center justify-between gap-2",children:[u.jsx("h2",{className:"mt-4 text-lg font-semibold text-green-700 mb-4 border-b border-green-300 pb-1",children:"MANTENIMIENTO DE TARJETAS MULTIFLOTA :"}),u.jsx("span",{className:"text-green-800",children:R?"EDITAR":"NUEVO"})]}),X.map(a=>a.items.length>0&&u.jsxs("div",{className:"mb-8",children:[u.jsx("h2",{className:"text-lg font-semibold text-green-700 mb-4 border-b border-green-300 pb-1",children:a.nombre}),u.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:a.items.map(e=>{const i=Y.findIndex(s=>s.metadata[0]===e.metadata[0]),{data:o,metadata:t}=e,h=Number(t?.[5]??0);let d=t?.[3]?Number(t[3]):0;const c=t?.[1]==="0",f=t?.[8]==="1",r=t?.[14]==="1";d=t?.[4]===""?d:Number(t[4]);const n={"-1":"w-1/2",1:"col-span-1",2:"col-span-2",3:"col-span-3",4:"col-span-4"};return u.jsx("div",{className:`${n[t?.[10]]??"col-span-1"} min-w-0`,children:u.jsx(P,{ref:s=>{s&&(m.current[t[6]]=s)},typeCode:h,etiqueta:t[7]??"",placeholder:t[7]??"",popupTipo:t[6]??"",url:je[t[6]]??"",onPopupClick:()=>he(t[6]),onPopupClose:()=>ge(t[6]),style:r?{visibility:"hidden",position:"absolute",width:0,height:0,overflow:"hidden"}:{},...d>0?{maxLength:d}:{},...f?{disabled:!0}:{},...c?{required:!0}:{},...h===103?{checked:(S[t[6]]?.value??o)==="1"}:{},...t?.[2]==="1"&&h===101?{tipoDato:"entero"}:{},...t?.[2]==="2"&&h===101?{tipoDato:"decimal"}:{},...h===111?{defaultValue:I[t[6]]?.length>0?e.metadata[0]:"",...t?.[11]==="1"?{isDefault:1}:{}}:h===151?{defaultValue:e.data,unaLinea:t?.[11],offsetColumnas:t?.[12],ancho:t?.[13],isFilter:(t[0]==="1.11",""),forcedOption:ee?.[t[6]]??null,optionFlag:te?.[t[6]]??null,setOptionFlag:s=>{E(l=>({...l,[t[6]]:s}))}}:{defaultValue:e.data},dataAttrs:{value:S[t[6]]?.value??o,valor:o,campo:t[0],item:t[6]},onChange:be,...I[t[6]]||S[t[0]]?.listaAux?{options:(()=>{const s=Te(t[6])||[],l=S[t[0]]?.listaAux,v=Array.isArray(l)?l.filter(g=>g&&g.trim()!==""):[];return s.concat(v)})()}:{}})},`${i}-${oe}`)})})]},a.id)),se&&u.jsx("div",{className:"flex justify-between items-center w-full gap-4 mt-8 mb-2",children:u.jsx(P,{typeCode:120,onClick:xe,className:"!w-auto",children:"NUEVA TARJETA MULTIFLOTA"})}),!R&&u.jsx("h2",{className:"mt-4 text-lg font-semibold text-green-700 mb-4 border-b border-green-300 pb-1",children:"HISTORIAL DE CAMBIOS DE TARJETAS MULTIFLOTA :"}),u.jsx("div",{className:"mb-4 flex-1 min-h-0 overflow-y-auto pr-2",children:R&&u.jsx("div",{style:{maxHeight:"50vh",overflowY:"auto",border:"1px solid #e5e7eb",borderRadius:"0.5rem"},children:u.jsx(Ae,{configTable:L,handleRadioClick:()=>{},handleCheckDelete:()=>{},isEditing:!1,onSelect:()=>{}})})}),u.jsxs("div",{className:"mt-8 mb-2",children:[K&&u.jsx("div",{className:"mt-3 p-3 text-sm text-white bg-red-400 rounded-md shadow-md animate-bounce",children:K}),U&&u.jsx("div",{className:`mt-3 p-3 text-sm rounded-md shadow-md ${_==="success"?"bg-green-700 text-white animate-bounce":_==="warning"?"bg-yellow-400 text-black animate-bounce":"bg-red-400 text-white animate-bounce"}`,children:U}),u.jsx("div",{className:"flex justify-between items-center w-full gap-4 mt-8 mb-2",children:u.jsx(P,{typeCode:120,onClick:Ee,className:"!w-auto",children:"GRABAR"})}),ae&&u.jsx(ye,{message:"¿Deseas guardar los cambios?",onConfirm:()=>{A(!1),le()},onCancel:()=>A(!1)})]}),$.visible&&u.jsx(Ne,{message:$.message,onClose:()=>b({visible:!1,message:""})})]})};export{Ue as default};
