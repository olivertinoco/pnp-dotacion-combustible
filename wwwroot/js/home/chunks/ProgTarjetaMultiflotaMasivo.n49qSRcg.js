import{r as t,j as e,u as Y}from"../index.BrPz-MZr.js";import{L as q}from"./Stack.DPLBjCES.js";import{B as Q}from"./BaseTablaMatriz2.CFIIuuYC.js";import{C as Z}from"./ConfirmDialog.YkHAmLtH.js";import{u as ee}from"./useTablaVirtualizadaCustom.y-cIBxX4.js";import{r as te,u as ae}from"./xlsx.D6SFf1Cq.js";const se=({onFileSelected:N,disabled:s=!1})=>{const[p,l]=t.useState(""),r=t.useRef(null),T=b=>{const o=b.target.files?.[0];if(!o)return;l(o.name);const C=new FileReader;C.onload=i=>{const g=i.target.result;N&&N({file:o,arrayBuffer:g})},C.readAsArrayBuffer(o)},h=()=>{s||r.current.click()};return e.jsxs("div",{className:"flex flex-col gap-3 w-full max-w-md",children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700",children:"Seleccionar archivo Excel"}),e.jsxs("div",{onClick:h,className:`w-full p-5 border-2 border-dashed rounded-xl flex flex-col items-center justify-center gap-2 transition-all duration-200
                  ${s?"bg-gray-100 border-gray-200 opacity-60 cursor-not-allowed select-none":"cursor-pointer border-gray-300 hover:border-blue-500 hover:bg-blue-50"}`,children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`w-10 h-10 ${s?"text-gray-300":"text-gray-500"}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 4v16m8-8H4"})}),e.jsx("p",{className:`text-sm ${s?"text-gray-400":"text-gray-600"}`,children:s?"deshabilitado para subir archivos":"Haz clic para seleccionar un archivo Excel"}),p&&e.jsxs("p",{className:"text-sm font-medium text-green-700 mt-1",children:["Archivo seleccionado: ",e.jsx("span",{className:"underline",children:p})]})]}),e.jsx("input",{ref:r,type:"file",accept:".xls, .xlsx",disabled:s,onChange:T,className:"hidden"})]})},ue=()=>{Y().state?.value;const[s,p]=t.useState(Date.now()),[l,r]=t.useState([]),[T,h]=t.useState({}),[b,o]=t.useState(!1),[C,i]=t.useState(!1),[g,S]=t.useState(!1),[$,w]=t.useState(!1),[O,j]=t.useState(""),[F,R]=t.useState("success"),[U,L]=t.useState(!1),[B,G]=t.useState(!1);t.useEffect(()=>{r([])},[]);const{runFetch:J}=ee(),z=({file:c,arrayBuffer:d})=>{const A=te(d,{type:"array"}),v=A.Sheets[A.SheetNames[0]],a=ae.sheet_to_json(v,{default:""}),y=Object.keys(a[0]||{}),u=[],m=[],f={};a.forEach((P,_)=>{const K=_+2,E=y.map(W=>(P[W]??"").toString().trim()),M=`${K}|${E.join("|")}`;if(!E[0]||!E[2]){m.push(M);return}const I=E[2];f[I]||(f[I]=[]),f[I].push(M),u.push(M)});const n=Object.values(f).filter(P=>P.length>1).flat(),x=["Nro|Placa Interna|Placa Rodaje|Nro Tarjeta Multiflota","50|200|200|400"];m.length>0?(m.unshift(x),r(m.flat()),i(!0)):n.length>0?(n.unshift(x),r(n.flat()),i(!0)):(u.unshift(x),r(u.flat()),i(!1)),G(!0)},H=()=>{if(l.length>0){const c="RESULTADO DE CARGA MASIVA DE TARJETAS MULTIFLOTA:";h(d=>({...d,title:c,isPaginar:!0,listaDatos:l,offsetColumnas:0})),o(!0),S(!0)}else alert("Debe cargar un archivo para procesar...")},D=()=>{r([]),h(c=>({...c,listaDatos:l})),o(!1),i(!0),S(!1),p(Date.now()),G(!1)},V=()=>{w(!0)},X=async()=>{L(!0);const c=l.slice(2).map(a=>{const[y,...u]=a.split("|");return u.join("|")});let d=2e3;const A=c.join("~"),v=new FormData;v.append("data",A);try{const a=await J("/Page/GrabarTarjetaMultiflotaMasivo",{method:"POST",body:v});if(a)if(L(!1),j("Proceso Terminado satisfactoriamente..."),R("success"),o(!0),S(!1),a.trim()!=="ok")if(a.trim().startsWith("error"))j("El archivo excel tiene DUPLICADO DE Nro PLACA INTERNA. Corrija los datos...!!!"),R("warning"),D(),d=3e3;else{const y=["Nro|Placa Interna|Placa Rodaje|Nro Tarjeta Multiflota|OBSERVACION","50|200|200|400|500"],m=a.trim().split("~").map((n,x)=>`${x+1}|${n}`),f=[...y,...m];h(n=>({...n,listaDatos:f}))}else D()}catch(a){L(!1),console.error(a),j("Error al guardar la informacion ..."),R("error")}finally{setTimeout(()=>{j("")},d)}},k=t.useCallback(()=>{},[]);return e.jsxs(e.Fragment,{children:[U&&e.jsx(q,{}),e.jsxs("div",{className:"text-xl font-bold mb-4 text-green-800 flex items-center justify-between gap-2",children:[e.jsx("h2",{className:"mt-4 text-lg font-semibold text-green-700 mb-4 border-b border-green-300 pb-1",children:"CARGA MASIVA DE LAS TARJETAS MULTIFLOTA :"}),e.jsx("a",{href:"/Page/DescargarPlantillaMultiflota",className:"mt-4 text-sm font-medium text-blue-600 underline hover:text-blue-800 transition",children:"DESCARGAR PLANTILLA EXCEL"})]}),e.jsx("div",{className:"p-4",children:e.jsx(se,{onFileSelected:z,disabled:B},s)}),O&&e.jsx("div",{className:`mt-3 p-3 text-sm rounded-md shadow-md ${F==="success"?"bg-green-700 text-white animate-bounce":F==="warning"?"bg-yellow-400 text-black animate-bounce":"bg-red-400 text-white animate-bounce"}`,children:O}),e.jsxs("div",{className:"flex justify-end items-center w-full gap-4 mt-8 mb-2",children:[e.jsx("button",{type:"button",onClick:g?V:H,className:"bg-green-700 text-white px-4 py-2 rounded-md hover:bg-green-900 transition",children:g?"PROCESAR":"MOSTRAR CARGA"}),e.jsx("button",{type:"button",onClick:D,className:"px-4 py-2 rounded-md shadow-sm bg-gray-300 text-black cursor-pointer opacity-50",children:"LIMPIAR"})]}),$&&e.jsx(Z,{message:"Â¿Deseas guardar los cambios?",onConfirm:()=>{w(!1),X()},onCancel:()=>w(!1)}),!b&&e.jsx("h2",{className:"mt-4 text-lg font-semibold text-green-700 mb-4 border-b border-green-300 pb-1",children:"Listado con formato XLXS : ( PLACA INTERNA - - PLACA RODAJE - - Nro TARJETA )"}),e.jsx("div",{className:"mb-4 flex-1 min-h-0 overflow-y-auto pr-2",children:b&&e.jsx("div",{style:{maxHeight:"80vh",overflowY:"auto",border:"1px solid #e5e7eb",borderRadius:"0.5rem"},children:e.jsx(Q,{configTable:T,handleRadioClick:k,handleCheckDelete:k,isEditing:!1,onSelect:k})})})]})};export{ue as default};
